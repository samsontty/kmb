<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
	<div id="result"></div>
<body>
	<script>
		const resultDiv = document.getElementById('result');
		const query = new URLSearchParams(window.location.search).get('query');
		if(query)
		{
      resultDiv.innerHTML = '';
      const entries = query.split(';');

      entries.forEach(entry => {
        const parts = entry.split('|');
        if (parts.length < 4) return;

        const [stopName, stopId, routeName, routeId] = parts;
        const apiUrl = `https://data.etabus.gov.hk/v1/transport/kmb/eta/${stopId}/${routeId}/1`;

        fetch(apiUrl)
          .then(res => res.json())
          .then(data => {
            const section = document.createElement('div');
            section.className = 'stop-section';
            section.innerHTML = `<h3>${routeName} â†’ ${stopName}</h3>`;

            if (data.data && data.data.length > 0) {
              const ul = document.createElement('ul');
              data.data.forEach(entry => {
                const li = document.createElement('li');
                if (entry.eta) {
                  const etaTime = new Date(entry.eta);
                  const now = new Date();
                  const diffMin = Math.max(0, Math.round((etaTime - now) / 60000));
                  const formatted = etaTime.toLocaleTimeString();
                  li.textContent = `ETA: ${formatted} (${diffMin} min${diffMin !== 1 ? 's' : ''} left)`;
                } else {
                  li.textContent = 'ETA: Not available';
                }
                ul.appendChild(li);
              });
              section.appendChild(ul);
            } else {
              section.innerHTML += `<p>No ETA data available.</p>`;
            }

            resultDiv.appendChild(section);
          })
          .catch(err => {
            const section = document.createElement('div');
            section.className = 'stop-section';
            section.innerHTML = `<h3>${routeName} â†’ ${stopName}</h3><p>Error fetching ETA: ${err.message}</p>`;
            resultDiv.appendChild(section);
          });
      });
	  
    }
	</script>
</body>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦™æ¸¯ä¹å·´åˆ°ç«™æ™‚é–“æŸ¥è©¢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #5D5CDE;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 min-h-screen transition-colors duration-300">
	<script>
	if (query)
	{
		window.stop();
	}
	</script>
    <div class="container mx-auto px-4 py-6 max-w-4xl">
        <!-- æ¨™é¡Œ -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">ğŸšŒ ä¹å·´åˆ°ç«™æ™‚é–“æŸ¥è©¢</h1>
            <p class="text-gray-600 dark:text-gray-400">æŸ¥è©¢é¦™æ¸¯ä¹é¾å·´å£«å³æ™‚åˆ°ç«™æ™‚é–“</p>
        </header>

        <!-- è¼‰å…¥ç‹€æ…‹ -->
        <div id="loadingMessage" class="text-center py-8">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600 dark:text-gray-400">æ­£åœ¨è¼‰å…¥å·´å£«è·¯ç·šè³‡æ–™...</p>
        </div>

        <!-- ä¸»è¦å…§å®¹ -->
        <div id="mainContent" class="hidden space-y-6">
            <!-- è·¯ç·šæœå°‹æ¡† -->
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                <label for="routeSearch" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    æœå°‹å·´å£«è·¯ç·š
                </label>
                <input type="text" id="routeSearch" placeholder="è¼¸å…¥è·¯ç·šè™Ÿç¢¼..." class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
            </div>

            <!-- è·¯ç·šé¸æ“‡ -->
            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6">
                <label for="routeSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    é¸æ“‡å·´å£«è·¯ç·š
                </label>
                <select id="routeSelect" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    <option value="">è«‹é¸æ“‡è·¯ç·š...</option>
                </select>
            </div>

            <!-- å·´å£«ç«™é¸æ“‡ -->
            <div id="stopSection" class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 hidden">
                <label for="stopSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    é¸æ“‡å·´å£«ç«™
                </label>
                <select id="stopSelect" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    <option value="">è«‹é¸æ“‡å·´å£«ç«™...</option>
                </select>
            </div>

            <!-- åˆ°ç«™æ™‚é–“é¡¯ç¤º -->
            <div id="etaSection" class="bg-gray-50 dark:bg-gray-800 rounded-lg p-6 hidden">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">åˆ°ç«™æ™‚é–“</h3>
                    <button id="refreshBtn" class="px-3 py-1 text-sm bg-primary text-white rounded-md hover:bg-primary/90 transition-colors focus:outline-none focus:ring-2 focus:ring-primary/50">
                        ğŸ”„ é‡æ–°æ•´ç†
                    </button>
                </div>
                <div id="etaList" class="space-y-3">
                    <!-- åˆ°ç«™æ™‚é–“æœƒåœ¨é€™è£¡é¡¯ç¤º -->
                </div>
            </div>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div id="errorMessage" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 text-red-700 dark:text-red-400 text-center">
            è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚
        </div>
    </div>

    <script>
        // æš—é»‘æ¨¡å¼æ”¯æ´
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // å…¨åŸŸè®Šæ•¸
        let routes = [];
        let stops = {};
        let routeStops = {};
        let originalRoutes = []; // å­˜å„²åŸå§‹è·¯ç·šæ•¸æ“š
        
        // DOM å…ƒç´ 
        const loadingMessage = document.getElementById('loadingMessage');
        const mainContent = document.getElementById('mainContent');
        const errorMessage = document.getElementById('errorMessage');
        const routeSelect = document.getElementById('routeSelect');
        const stopSelect = document.getElementById('stopSelect');
        const stopSection = document.getElementById('stopSection');
        const etaSection = document.getElementById('etaSection');
        const etaList = document.getElementById('etaList');
        const refreshBtn = document.getElementById('refreshBtn');
        const routeSearch = document.getElementById('routeSearch');

        // API åŸºç¤ URL
        const API_BASE = 'https://data.etabus.gov.hk/v1/transport/kmb';

        // åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼
        async function initApp() {
            try {
                await loadRoutes();
                await loadStops();
                await loadRouteStops();
                
                originalRoutes = [...routes]; // ä¿å­˜åŸå§‹è·¯ç·šæ•¸æ“š
                populateRouteSelect();
                setupEventListeners();
                
                hideLoading();
                showMainContent();
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                hideLoading();
                showError();
            }
        }

        // è¼‰å…¥æ‰€æœ‰è·¯ç·š
        async function loadRoutes() {
            const response = await fetch(`${API_BASE}/route/`);
            const data = await response.json();
            routes = data.data || [];
        }

        // è¼‰å…¥æ‰€æœ‰å·´å£«ç«™
        async function loadStops() {
            const response = await fetch(`${API_BASE}/stop/`);
            const data = await response.json();
            const stopsArray = data.data || [];
            
            // è½‰æ›ç‚ºä»¥ stop_id ç‚ºéµçš„ç‰©ä»¶
            stops = {};
            stopsArray.forEach(stop => {
                stops[stop.stop] = stop;
            });
        }

        // è¼‰å…¥è·¯ç·š-å·´å£«ç«™é—œä¿‚
        async function loadRouteStops() {
            const response = await fetch(`${API_BASE}/route-stop/`);
            const data = await response.json();
            const routeStopsArray = data.data || [];
            
            // æŒ‰è·¯ç·šåˆ†çµ„
            routeStops = {};
            routeStopsArray.forEach(rs => {
                const key = `${rs.route}-${rs.bound}-${rs.service_type}`;
                if (!routeStops[key]) {
                    routeStops[key] = [];
                }
                routeStops[key].push(rs);
            });

            // æŒ‰åºè™Ÿæ’åº
            Object.keys(routeStops).forEach(key => {
                routeStops[key].sort((a, b) => a.seq - b.seq);
            });
        }

        function reinitRoute()
        {
            route = [...originalRoutes];
            populateRouteSelect();
        }

        // å¡«å……è·¯ç·šé¸æ“‡æ¡†
        function populateRouteSelect() {
            routeSelect.innerHTML = '<option value="">è«‹é¸æ“‡è·¯ç·š...</option>';
            const sortedRoutes = routes.sort((a, b) => {
                const aIsNum = /^\d+$/.test(a.route);
                const bIsNum = /^\d+$/.test(b.route);
                
                if (aIsNum && bIsNum) {
                    return parseInt(a.route) - parseInt(b.route);
                }
                if (aIsNum && !bIsNum) return -1;
                if (!aIsNum && bIsNum) return 1;
                return a.route.localeCompare(b.route);
            });

            const routeOptions = {};
            sortedRoutes.forEach(route => {
                const key = route.route;
                if (!routeOptions[key]) {
                    routeOptions[key] = [];
                }
                routeOptions[key].push(route);
            });

            Object.keys(routeOptions).forEach(routeNum => {
                const routeVariants = routeOptions[routeNum];
                routeVariants.forEach(route => {
                    const option = document.createElement('option');
                    option.value = `${route.route}-${route.bound}-${route.service_type}`;
                    const directionText = route.bound === 'O' ? 'å¾€' : 'å›';
                    option.textContent = `${route.route} ( ${route.orig_tc} ${directionText} ${route.dest_tc} )`;
                    routeSelect.appendChild(option);
                });
            });
        }

        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            routeSelect.addEventListener('change', onRouteChange);
            stopSelect.addEventListener('change', onStopChange);
            refreshBtn.addEventListener('click', refreshETA);
            let timeout;
            routeSearch.addEventListener('keyup', () => {
                
                clearTimeout(timeout);
                timeout = setTimeout(() =>
                {
                    reinitRoute();
                    timeout = setTimeout(filterRoutes, 300);
                }, 500);
                
            });
        }

        // è·¯ç·šæ”¹è®Šäº‹ä»¶
        function onRouteChange() {
            const selectedRoute = routeSelect.value;
            if (!selectedRoute) {
                hideStopSection();
                hideETASection();
                return;
            }

            populateStopSelect(selectedRoute);
            showStopSection();
            hideETASection();
        }

        // å¡«å……å·´å£«ç«™é¸æ“‡æ¡†
        function populateStopSelect(routeKey) {
            stopSelect.innerHTML = '<option value="">è«‹é¸æ“‡å·´å£«ç«™...</option>';
            const stopsForRoute = routeStops[routeKey] || [];
            const addedStops = new Set(); // Use a Set to track added stops
            
            stopsForRoute.forEach(rs => {
                const stop = stops[rs.stop];
                if (stop && !addedStops.has(rs.stop)) { // Check if the stop has already been added
                    addedStops.add(rs.stop);
                    const option = document.createElement('option');
                    option.value = rs.stop;
                    option.textContent = stop.name_tc;
                    stopSelect.appendChild(option);
                }
            });
        }

        // å·´å£«ç«™æ”¹è®Šäº‹ä»¶
        function onStopChange() {
            const selectedStop = stopSelect.value;
            if (!selectedStop) {
                hideETASection();
                return;
            }

            showETASection();
            loadETA();
        }

        // è¼‰å…¥åˆ°ç«™æ™‚é–“
        async function loadETA() {
            const selectedRoute = routeSelect.value;
            const selectedStop = stopSelect.value;

            // Get the displayed text for the selected route
            let selectedText = '';
            for (let option of routeSelect.options) {
                if (option.value === selectedRoute) {
                    selectedText = option.text; // Get the displayed text
                    break; // Exit the loop once found
                }
            }
			// Get the displayed text for the selected route
            let stopText = 'NIL';
            for (let option of stopSelect.options) {
                if (option.value === selectedStop) {
                    stopText = option.textContent; // Get the displayed text
                    break; // Exit the loop once found
                }
            }

            if (!selectedRoute || !selectedStop) return;

            const [route, bound, serviceType] = selectedRoute.split('-');
            
            const currentUrl = window.location.href;
			// Create a new URL object
			const url = new URL(currentUrl);
			// Replace the last part (filename) with "kmb.html"
			const newURL = url.pathname;
			const targetURL = `${newURL}?query=${stopText}|${selectedStop}|${selectedText}|${route}`
			const ext_link_html = `<p class="text-gray-500 dark:text-gray-400 text-center py-4"><a href='${targetURL}'>Saved Link</a></p>`;
			
            
            try {
                showETALoading();
                const response = await fetch(`${API_BASE}/eta/${selectedStop}/${route}/${serviceType}`);
                const data = await response.json();
                
                displayETA(selectedText, data.data || []);
            } catch (error) {
                console.error('è¼‰å…¥åˆ°ç«™æ™‚é–“å¤±æ•—:', error);
                showETAError();
            }
            
            etaList.innerHTML = ext_link_html + etaList.innerHTML;

        }

        // é¡¯ç¤ºåˆ°ç«™æ™‚é–“
        function displayETA(route, etaData) {
            etaList.innerHTML = '';
            
            if (etaData.length === 0) {
                etaList.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-4">æš«ç„¡åˆ°ç«™æ™‚é–“è³‡æ–™</p>';
                return;
            }

            etaData.forEach((eta, index) => {
                
                if (route.includes("å¾€") && eta.dir !== 'O') 
                {
                    return;
                } 
                else if (route.includes("å›") && eta.dir != 'I')
                {
                    return;
                }
                
                const etaDiv = document.createElement('div');
                etaDiv.className = 'bg-white dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 fade-in';
                
                let timeDisplay = '';
                let statusClass = '';
                
                if (eta.eta) {
                    const etaTime = new Date(eta.eta);
                    const now = new Date();
                    const diffMinutes = Math.round((etaTime - now) / 60000);
                    
                    if (diffMinutes <= 0) {
                        timeDisplay = 'å³å°‡åˆ°ç«™';
                        statusClass = 'text-red-600 dark:text-red-400';
                    } else if (diffMinutes <= 2) {
                        timeDisplay = `${diffMinutes} åˆ†é˜`;
                        statusClass = 'text-orange-600 dark:text-orange-400';
                    } else {
                        timeDisplay = `${diffMinutes} åˆ†é˜`;
                        statusClass = 'text-green-600 dark:text-green-400';
                    }
                    
                    const etaTimeStr = etaTime.toLocaleTimeString('zh-HK', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    const boundText = eta.dir === 'O' ? 'å¾€' : 'å›';
                    
                    etaDiv.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="font-semibold text-gray-900 dark:text-white">
                                    ç¬¬ ${index + 1} ç­è»Š (${boundText})
                                </div>
                                <div class="text-sm text-gray-600 dark:text-gray-400">
                                    é è¨ˆåˆ°ç«™: ${etaTimeStr}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold ${statusClass}">
                                    ${timeDisplay}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    etaDiv.innerHTML = `
                        <div class="text-center text-gray-500 dark:text-gray-400">
                            ç¬¬ ${index + 1} ç­è»Š - æš«ç„¡è³‡æ–™
                        </div>
                    `;
                }
                
                etaList.appendChild(etaDiv);
            });
        }

        // é‡æ–°æ•´ç†åˆ°ç«™æ™‚é–“
        function refreshETA() {
            loadETA();
        }

        // é¡¯ç¤ºåˆ°ç«™æ™‚é–“è¼‰å…¥ç‹€æ…‹
        function showETALoading() {
            etaList.innerHTML = `
                <div class="text-center py-4">
                    <div class="loading-spinner mx-auto mb-2"></div>
                    <p class="text-gray-600 dark:text-gray-400">è¼‰å…¥åˆ°ç«™æ™‚é–“...</p>
                </div>
            `;
        }

        // é¡¯ç¤ºåˆ°ç«™æ™‚é–“éŒ¯èª¤
        function showETAError() {
            etaList.innerHTML = `
                <div class="text-center py-4 text-red-600 dark:text-red-400">
                    è¼‰å…¥åˆ°ç«™æ™‚é–“å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦
                </div>
            `;
        }

        // UI æ§åˆ¶å‡½æ•¸
        function hideLoading() {
            loadingMessage.classList.add('hidden');
        }

        function showMainContent() {
            mainContent.classList.remove('hidden');
        }

        function showError() {
            errorMessage.classList.remove('hidden');
        }

        function showStopSection() {
            stopSection.classList.remove('hidden');
            stopSection.classList.add('fade-in');
        }

        function hideStopSection() {
            stopSection.classList.add('hidden');
        }

        function showETASection() {
            etaSection.classList.remove('hidden');
            etaSection.classList.add('fade-in');
        }

        function hideETASection() {
            etaSection.classList.add('hidden');
        }

        // è·¯ç·šæœå°‹éæ¿¾
        function filterRoutes() {
            
            //alert(`é¡¯ç¤ºçš„é¸é …: ${shouldDisplay.join(', ')}`);
            const query = routeSearch.value.toLowerCase();
            const options = Array.from(routeSelect.options);
            const shouldDisplay = [];

            // æ¸…ç©ºé¸é …
            routeSelect.innerHTML = '';

            // æ·»åŠ â€œè«‹é¸æ“‡è·¯ç·š...â€é¸é …
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'è«‹é¸æ“‡è·¯ç·š...';
            routeSelect.appendChild(defaultOption);

            options.forEach(option => {
                const display = option.value && option.text.toLowerCase().includes(query);
                
                if (display) {
                    // å°‡ç¬¦åˆæ¢ä»¶çš„é¸é …æ·»åŠ åˆ°ä¸‹æ‹‰æ¡†
                    const newOption = document.createElement('option');
                    newOption.value = option.value;
                    newOption.textContent = option.text;
                    routeSelect.appendChild(newOption);
                    shouldDisplay.push(option.text);
                }
            });

            // å¦‚æœæ²’æœ‰åŒ¹é…çš„é¸é …ï¼Œé‡ç½®é¸æ“‡
            //if (shouldDisplay.length === 0) {
                routeSelect.selectedIndex = 0;
            //     // è‡ªå‹•é¸æ“‡ç¬¬ä¸€å€‹åŒ¹é…çš„é¸é …
            //     routeSelect.selectedIndex = 1; // 1å› ç‚º0æ˜¯é»˜èªé¸é …
            // }

            // ä½¿ç”¨ setTimeout ä¾†å»¶é²æ·»åŠ äº‹ä»¶ç›£è½å™¨
            // setTimeout(() => {
            //     setupEventListeners();
            // }, 0);

            // å½ˆå‡ºæ¶ˆæ¯é¡¯ç¤ºæ‡‰é¡¯ç¤ºçš„é¸é …
            //alert(`é¡¯ç¤ºçš„é¸é …: ${shouldDisplay.join(', ')}`);
        }

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>